// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ç”¨æˆ·æ¨¡å‹
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String   // bcrypt hashed
  avatar    String?  // å¤´åƒURL
  role      String   @default("user") // user, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// Agentæ¨¡æ¿ - BMADé£æ ¼çš„Agentå®šä¹‰
model AgentTemplate {
  id            String   @id @default(uuid())
  code          String   @unique  // pm, architect, dev, qa, ux, devops, sm
  name          String            // "John", "Winston", "Amelia"
  title         String            // "Product Manager", "System Architect"
  icon          String            // emoji: ğŸ“‹, ğŸ—ï¸, ğŸ’»

  // Persona é…ç½®
  role          String            // è§’è‰²æè¿°
  experience    String?           // ç»éªŒæè¿°
  expertise     String            // JSON: ä¸“é•¿é¢†åŸŸæ•°ç»„
  communication String?           // æ²Ÿé€šé£æ ¼

  // è¡Œä¸ºé…ç½®
  principles    String            // JSON: æ ¸å¿ƒåŸåˆ™æ•°ç»„
  workflows     String            // JSON: å¯æ‰§è¡Œå·¥ä½œæµä»£ç æ•°ç»„

  // ç³»ç»Ÿå­—æ®µ
  isBuiltIn     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  devices       Device[]

  @@map("agent_templates")
}

// è®¾å¤‡æ¨¡å‹
model Device {
  id              String   @id @default(uuid())
  name            String   @unique
  type            String   // vscode, windsurf, antigravity, claude-code, other
  role            String?  // å›¢é˜Ÿè§’è‰²: frontend, backend, fullstack, devops, qa, architect, pm, designer
  skills          String?  // JSONæ•°ç»„: åˆ†é…çš„æŠ€èƒ½åˆ—è¡¨
  documentIds     String?  // JSONæ•°ç»„: å…³è”çš„æ–‡æ¡£IDåˆ—è¡¨
  status          String   @default("offline") // online, offline, idle, working
  os              String
  ip              String
  currentProject  String?
  currentModule   String?
  metadata        String?  // JSON string for additional info
  lastSeen        DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // BMAD æ‰©å±•å­—æ®µ
  agentTemplateId String?          // å…³è”çš„ Agent æ¨¡æ¿
  agentConfig     String?          // JSON: è‡ªå®šä¹‰é…ç½®è¦†ç›–
  skillLevel      String   @default("intermediate")  // beginner/intermediate/expert

  // Relations
  contributions      Contribution[]
  tasks              Task[]
  agentTemplate      AgentTemplate?      @relation(fields: [agentTemplateId], references: [id])
  workflowExecutions WorkflowExecution[]
  teamMembers        TeamMember[]

  @@map("devices")
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String
  repository  String
  status      String   @default("active") // active, paused, completed
  startDate   DateTime @default(now())
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // å¤æ‚åº¦è¯„ä¼° (BMAD Scale-Adaptive)
  complexity  String?  // small/medium/large/enterprise

  // Relations
  contributions      Contribution[]
  tasks              Task[]
  workflowExecutions WorkflowExecution[]

  @@map("projects")
}

model Contribution {
  id           String   @id @default(uuid())
  deviceId     String
  projectId    String
  commits      Int      @default(0)
  linesAdded   Int      @default(0)
  linesDeleted Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  device  Device  @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([deviceId, projectId])
  @@map("contributions")
}

model Task {
  id          String   @id @default(uuid())
  deviceId    String
  projectId   String
  module      String
  description String
  status      String   @default("active") // active, completed, paused
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  device  Device  @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model Document {
  id        String   @id @default(uuid())
  title     String
  content   String
  category  String   // standard, tech, bug, other
  tags      String   // JSON array string
  author    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("documents")
}

// ==================== BMAD å·¥ä½œæµç³»ç»Ÿ ====================

// å·¥ä½œæµå®šä¹‰
model Workflow {
  id            String   @id @default(uuid())
  code          String   @unique  // create-prd, dev-story, code-review, etc.
  name          String            // "Create PRD", "Dev Story"
  description   String
  phase         Int               // 1-4 (åˆ†æ/è§„åˆ’/æ–¹æ¡ˆ/å®æ–½)

  // å·¥ä½œæµé…ç½®
  agentCode     String            // æ‰§è¡Œæ­¤å·¥ä½œæµçš„ Agent ä»£ç 
  steps         String            // JSON: æ­¥éª¤å®šä¹‰æ•°ç»„
  inputs        String?           // JSON: æ‰€éœ€è¾“å…¥å®šä¹‰
  outputs       String?           // JSON: è¾“å‡ºäº§ç‰©å®šä¹‰

  // ä¾èµ–å…³ç³»
  prerequisites String?           // JSON: å‰ç½®å·¥ä½œæµä»£ç æ•°ç»„

  // åˆ†ç±»
  category      String   @default("general")  // quick-flow, full-flow, qa, etc.

  // ç³»ç»Ÿå­—æ®µ
  isBuiltIn     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  executions    WorkflowExecution[]

  @@map("workflows")
}

// å·¥ä½œæµæ‰§è¡Œå®ä¾‹
model WorkflowExecution {
  id          String   @id @default(uuid())
  workflowId  String
  projectId   String
  deviceId    String            // æ‰§è¡Œçš„ Agent/Device

  status      String   @default("pending")  // pending/running/paused/completed/failed
  progress    Int      @default(0)          // 0-100
  currentStep Int      @default(0)

  // æ‰§è¡Œæ•°æ®
  inputs      String?           // JSON: å®é™…è¾“å…¥
  outputs     String?           // JSON: å®é™…è¾“å‡º
  logs        String?           // JSON: æ‰§è¡Œæ—¥å¿—æ•°ç»„

  // æ—¶é—´è¿½è¸ª
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workflow    Workflow @relation(fields: [workflowId], references: [id])
  project     Project  @relation(fields: [projectId], references: [id])
  device      Device   @relation(fields: [deviceId], references: [id])

  @@map("workflow_executions")
}

// ==================== BMAD å›¢é˜Ÿç³»ç»Ÿ ====================

// å›¢é˜Ÿå®šä¹‰
model Team {
  id          String   @id @default(uuid())
  name        String
  description String?

  // å›¢é˜Ÿé…ç½®
  mode        String   @default("sequential")  // sequential/parallel/collaborative

  // é»˜è®¤å·¥ä½œæµç¨‹
  defaultWorkflows String?      // JSON: é»˜è®¤å·¥ä½œæµä»£ç åºåˆ—

  // ç³»ç»Ÿå­—æ®µ
  isBuiltIn   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     TeamMember[]

  @@map("teams")
}

// å›¢é˜Ÿæˆå‘˜
model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  deviceId  String

  // æˆå‘˜é…ç½®
  role      String?           // åœ¨å›¢é˜Ÿä¸­çš„è§’è‰²
  priority  Int      @default(0)  // ä¼˜å…ˆçº§

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([teamId, deviceId])
  @@map("team_members")
}
